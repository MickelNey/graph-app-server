// https://github.com/john-guerra/netClusteringJS#readme v0.0.7 Copyright 2022 John Alexis Guerra GÃ³mez
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):e.netClustering=r()}(this,function(){"use strict";return function(){let e={};function r(e,n,t,i,a,s){n[e].leftChild>-1&&(t+=1,a&&a(e,n,t),r(n[e].leftChild,n,t,i,a,s)),-1==n[e].rightChild&&i&&i(e,n,t),n[e].rightChild>-1&&(r(n[e].rightChild,n,t,i,a,s),s&&s(e,n,t),t-=1)}function n(e,r,n){var t=e.length,i={};for(var a in r){var s=r[a],u=a.split("~"),o=Number(u[0]),f=Number(u[1]);i[o]||(i[o]=[]),i[f]||(i[f]=[]),i[o].push({dQ:s,i:o,j:f}),i[f].push({dQ:s,i:o,j:f})}var l={dQ:-1/0,i:-1,j:-1};for(o=0;o<t;o++)i[o]&&(i[o].sort(function(e,r){return r.dQ-e.dQ}),i[o][0].dQ>l.dQ&&(l.dQ=i[o][0].dQ,l.i=i[o][0].i,l.j=i[o][0].j));if(-1==l.i)return null;var c=e[l.i].weight+e[l.j].weight;e.push({parent:-1,leftChild:l.i,rightChild:l.j,weight:c,dQ:l.dQ}),e[l.i].parent=t,e[l.j].parent=t;for(var h=[],d=0;d<t;d++)if(d!=l.i&&d!=l.j&&i[d]){var m=Math.min(l.i,d)+"~"+Math.max(l.i,d),v=Math.min(l.j,d)+"~"+Math.max(l.j,d),p=d+"~"+t,g=r[m],b=r[v];isNaN(g)?isNaN(b)?r[p]=null:(h.push(v),r[p]=b-2*n[l.i]*n[d]):(h.push(m),isNaN(b)?r[p]=g-2*n[l.j]*n[d]:(h.push(v),r[p]=g+b))}n[t]=n[l.i]+n[l.j],r[l.i+"~"+l.j]=null;for(o=0;o<h.length;o++)r[h[o]]=null;var N={};for(var a in r)r[a]&&(N[a]=r[a]);return{value:l.dQ,array:N}}function t(e,t){for(var i=e.names.length,a=[],s=0;s<i;s++)a[s]=0;var u=0,o=0;if(e.useWeights){for(var f in e.distances){var l=f.split("~"),c=(s=Number(l[0]),Number(l[1])),h=e.distances[f];a[s]+=h,a[c]+=h,o+=h,u+=1}o||(o=1e-7);var d=1/(2*o)}else{for(var f in e.distances){l=f.split("~"),s=Number(l[0]),c=Number(l[1]);a[s]+=1,a[c]+=1,u+=1}u||(u=1e-7);d=1/(2*u)}var m={};for(var f in e.distances){l=f.split("~"),s=Number(l[0]),c=Number(l[1]);e.useWeights?m[f]=2*d*e.distances[f]-2*d*d*a[s]*a[c]:m[f]=2*(d-a[s]*a[c]*d*d)}var v=[];for(s=0;s<i;s++)v[s]=d*a[s];var p=[];for(s=0;s<i;s++)p.push({parent:-1,leftChild:-1,rightChild:-1,weight:1,linkage:v[s],name:e.names[s],primaryKey:s});for(var g=0,b=-1/0,N={value:0,array:m},j=1;N&&p.length<2*i-1;){if(!(N=n(p,N.array,v)))return null;g+=N.value,N.value<0&&(j+=1),b=Math.max(b,g)}var M=0,y=p.length-1;if(r(y,p,0,function(e,r,n){r[e].index=M,M+=1},null,null),t){var Q=i+" nodes, "+u+" of "+i*(i-1)/2+" possible edges ("+Math.round(200*u/(i*(i-1)))+"%) ";Q+="with data, and "+j+" primary communities identified.",Q+="&nbsp; &nbsp; Q="+b.toFixed(3),document.getElementById("notes").innerHTML=Q}return{tree:p,distances:e.distances,root:y,names:e.names,useWeights:e.useWeights}}function i(e){var n=!0,t=[],i=-1,a=[],s="",u=0;r(e.root,e.tree,0,function(r,u,o){n&&(i+=1,t.push(r),n=!1),a[r]=i,s+=e.tree[r].name+","},function(e,r,t){r[e].dQ<0&&(n=!0,u=0),u+=1},function(e,r,t){r[e];1==(u-=1)&&(n=!0,s+="~")});var o=i+1;return s=(s=s.slice(0,-2)).replace(/,~/g,"~"),{numGroups:o,group:a,members:s,breakNodes:t}}function a(e,r,n){if(e){e.tree,e.root;for(var s=e.names,u=i(e),o=u.numGroups,f=u.group,l=u.members.split("~"),c=[],h=0;h<l.length;h++)c.push(l[h].split(","));var d=[];for(h=0;h<o;h++)d.push({names:[],distances:[],useWeights:e.useWeights});for(var m=[],v=0;v<s.length;v++){var p=s[v];d[f[v]].names.push(p),m[v]=d[f[v]].names.length-1}for(var g in e.distances){var b=g.split("~"),N=(v=Number(b[0]),Number(b[1]));if(f[v]==f[N]){var j=m[v]+"~"+m[N];d[f[v]].distances[j]=e.distances[g]}}if(o>1)for(h=0;h<o;h++){var M=t(d[h]);if(M&&M.tree)if(i(M).numGroups>1){var y=a(M,r+1,h);c[h]=y}}return c}}return e.buildTreeByCommunities=t,e.findSubCommunities=a,e.cluster=function(e,r,n,i){var s={},u=[];void 0===n&&(n="cluster"),void 0===i&&(i="value");var o=[];return r.length>0&&"object"==typeof r[0].source?o=r.map(function(r){var n=e.indexOf(r.source),t=e.indexOf(r.target);return-1===n||-1===t?null:{source:n,target:t,count:void 0!==r[i]?r[i]:1}}):r.forEach(function(e){o.push({source:e.source,target:e.target,count:void 0!==e[i]?e[i]:1})}),s.method="newman",s.useWeights=!0,s.names=e.map(function(e,r){return""+r}),s.distances={},(o=o.filter(function(e){return e.source!==e.target})).forEach(function(e){var r=Math.min(e.source,e.target)+"~"+Math.max(e.source,e.target);s.distances[r]=+e.count}),(u=function e(r){var n,t;for(n=0;n<r.length;n++)if((t=r[n])instanceof Array)0===(t=e(t)).length&&r.splice(n,1);else if("DUMMY"===t||"DUMM"===t){r.splice(n,1);break}return r}(u=a(t(s=function(e){return e.names.push("DUMMY"),e.names.forEach(function(r,n){if(n!==e.names.length-1){var t=n+"~"+(e.names.length-1);e.distances[t]=.1}}),e}(s),!1),0))).forEach(function(r,t){!function r(t,i){t instanceof Array?t.forEach(function(e){r(e,i)}):e[+t][n]=i.toString()}(r,t)}),u},e}()});
